# 管理者画面機能拡張 - フェーズ1 実装ドキュメント

**実施日**: 2026年2月3日  
**対象**: 管理者画面の機能拡張（却下理由履歴、編集追跡、投稿状態の可視化）

---

## 📋 目次

1. [実装概要](#実装概要)
2. [既存列の調査結果](#既存列の調査結果)
3. [フェーズ1の実装内容](#フェーズ1の実装内容)
4. [データ構造とフロー](#データ構造とフロー)
5. [テスト方法](#テスト方法)
6. [次のステップ](#次のステップ)

---

## 実装概要

### 🎯 実装した機能

1. **最終編集日時の更新ロジック修正**
   - 初回投稿時に最終編集日時を記録
   - 編集時に自動更新
   - 却下時にクリアして再編集を促す

2. **却下理由の履歴保存機能**
   - 却下理由が上書きされず履歴として蓄積
   - 全ての却下理由を日時付きで保存

3. **新規投稿と再編集の可視化**
   - 初回投稿日時の記録
   - 編集回数のカウント
   - 投稿状態（新規/再編集）の明示

### ⚠️ 解決した問題

| 問題 | 解決方法 |
|------|---------|
| 却下が繰り返されると却下理由が上書きされる | BO列（却下理由履歴）を追加して全履歴を保存 |
| 最終編集日時が更新されない | onFormSubmitとonEditTriggerを改善 |
| 新規投稿と再編集の区別がつかない | BN列（投稿状態）を追加 |
| 初回投稿日時がわからない | BL列（初回投稿日時）を追加 |

---

## 既存列の調査結果

### 📊 既存列（BF〜BK）の状態

| 列 | インデックス | 列名 | 状態 | 用途 |
|----|------------|------|------|------|
| **BF** | 57 | メールアドレス | ✅ 正常動作 | 承認/却下メール送信先 |
| **BG** | 58 | 承認ステータス | ✅ 正常動作 | 未承認/承認済み/却下の管理 |
| **BH** | 59 | 承認日時 | ✅ 正常動作 | 承認・却下日時の記録 |
| **BI** | 60 | 最終編集日時 | ⚠️ 改善済み | 編集日時の記録 |
| **BJ** | 61 | 承認回数 | ✅ 正常動作 | 承認回数のカウント |
| **BK** | 62 | 却下理由 | ⚠️ 改善済み | 最新の却下理由（上書き） |

### 各列の詳細

#### BF列（メールアドレス）
- **使用箇所**: `approveExperience()`, `rejectExperience()`
- **動作**: 承認/却下時にメール送信
- **問題**: なし

#### BG列（承認ステータス）
- **値**: 「未承認」「承認済み」「却下」
- **使用箇所**: 全ての管理者機能
- **データフロー**:
  ```
  新規投稿 → 「未承認」
       ↓
  承認/却下 → 「承認済み」「却下」
       ↓
  編集発生 → 「未承認」（に戻る）
  ```
- **問題**: なし

#### BH列（承認日時）
- **動作**: 承認時・却下時に日時を記録
- **注意**: 承認と却下で同じ列を使用（ステータスで判別）
- **問題**: なし

#### BI列（最終編集日時）
- **元の問題**: 新規投稿時に設定されない
- **改善内容**: 
  - `onFormSubmit`で初回投稿時に設定
  - `onEditTrigger`で編集時に更新
  - `rejectExperience`で却下時にクリア

#### BJ列（承認回数）
- **動作**: 承認のたびに+1
- **用途**: 編集→承認のサイクルを追跡
- **問題**: なし

#### BK列（却下理由）
- **元の問題**: 却下が繰り返されると上書きされる
- **改善内容**: 
  - BK列: 最新の却下理由（表示用）
  - BO列: 全ての却下理由履歴（新規追加）

---

## フェーズ1の実装内容

### 🆕 新規追加列

| 列番号 | 列名 | 用途 | 実装内容 |
|--------|------|------|---------|
| **BL (63)** | 初回投稿日時 | 最初に投稿された日時を記録 | onFormSubmitで設定 |
| **BM (64)** | 編集回数 | 何回編集されたかをカウント | onEditTriggerでインクリメント |
| **BN (65)** | 投稿状態 | 新規投稿/再編集/承認後編集 | 状況に応じて設定 |
| **BO (66)** | 却下理由履歴 | 全ての却下理由を保存 | 日時付きで追記 |

### 📝 修正した関数

#### 1. onFormSubmit（新規投稿時）
```javascript
// 追加した処理
- 承認ステータス → 「未承認」
- 初回投稿日時 → 現在時刻（新規）
- 最終編集日時 → 現在時刻（追加）
- 編集回数 → 0（新規）
- 投稿状態 → 「新規投稿」（新規）
```

#### 2. onEditTrigger（編集時）
```javascript
// 追加した処理
- 承認ステータス → 「未承認」（承認済み/却下から戻す）
- 最終編集日時 → 現在時刻
- 編集回数 → +1（新規）
- 投稿状態 → 「再編集」（新規）
```

#### 3. approveExperience（承認時）
```javascript
// 追加した処理
- 承認ステータス → 「承認済み」
- 承認日時 → 現在時刻
- 承認回数 → +1
- 投稿状態 → 編集回数に基づいて設定（新規）
  - 編集回数0 → 「新規投稿」
  - 編集回数1以上 → 「再編集」
```

#### 4. rejectExperience（却下時）
```javascript
// 追加した処理
- 承認ステータス → 「却下」
- 最新の却下理由 → BK列に保存
- 却下理由履歴 → BO列に追記（新規）
- 却下日時 → 現在時刻
- 最終編集日時 → クリア（再編集を促す）
```

#### 5. addRejectReasonToHistory（新規作成）
```javascript
// 却下理由履歴に追加
function addRejectReasonToHistory(existingHistory, newReason) {
  const timestamp = '[2026/02/03 10:30]';
  const newEntry = timestamp + ' ' + newReason;
  return existingHistory + '\n' + newEntry;
}
```

### 🔄 API応答の拡張

#### getPendingExperiences
**追加されたフィールド**:
- `firstSubmitDate`: 初回投稿日時
- `editCount`: 編集回数
- `submissionState`: 投稿状態
- `rejectReason`: 最新の却下理由
- `rejectReasonHistory`: 却下理由履歴

#### getApprovedExperiences
**追加されたフィールド**:
- `firstSubmitDate`: 初回投稿日時
- `editCount`: 編集回数
- `submissionState`: 投稿状態

#### getExperienceById
**追加されたフィールド**:
- `approvalStatus`: 承認ステータス
- `approvalDate`: 承認日時
- `lastEditDate`: 最終編集日時
- `approvalCount`: 承認回数
- `rejectReason`: 最新の却下理由
- `firstSubmitDate`: 初回投稿日時
- `editCount`: 編集回数
- `submissionState`: 投稿状態
- `rejectReasonHistory`: 却下理由履歴

---

## データ構造とフロー

### シナリオ1: 新規投稿から承認まで

```
1. ユーザーがGoogleフォームで投稿
   ↓
2. onFormSubmit トリガー発火
   BG列: 「未承認」
   BI列: 2026/02/03 10:00（最終編集日時）
   BL列: 2026/02/03 10:00（初回投稿日時）
   BM列: 0（編集回数）
   BN列: 「新規投稿」
   ↓
3. 管理者が内容を確認
   ↓
4. 管理者が承認
   BG列: 「承認済み」
   BH列: 2026/02/03 14:00（承認日時）
   BJ列: 1（承認回数）
   ↓
5. 承認メール送信（BF列のアドレス宛）
   ↓
6. 体験談が公開される
```

### シナリオ2: 却下と再編集

```
1. 管理者が却下
   BG列: 「却下」
   BH列: 2026/02/03 14:00（却下日時）
   BI列: （クリア）
   BK列: 「詳細が不足しています」
   BO列: 「[2026/02/03 14:00] 詳細が不足しています」
   ↓
2. 却下メール送信（理由を含む）
   ↓
3. ユーザーが回答を編集
   ↓
4. onEditTrigger 発火
   BG列: 「未承認」（却下から戻る）
   BI列: 2026/02/03 15:30（最終編集日時）
   BM列: 1（編集回数+1）
   BN列: 「再編集」
   ↓
5. 管理者が再度確認
   - 「再編集」バッジが表示される
   - 前回の却下理由が表示される
   ↓
6a. 承認 → 公開
   または
6b. 再度却下
   BG列: 「却下」
   BK列: 「個人情報が含まれています」
   BO列: 「[2026/02/03 14:00] 詳細が不足しています
          [2026/02/03 16:00] 個人情報が含まれています」
```

### シナリオ3: 承認後の編集

```
1. 承認済みの体験談がある
   BG列: 「承認済み」
   ↓
2. ユーザーが内容を編集
   ↓
3. onEditTrigger 発火
   BG列: 「未承認」（承認済みから戻る）
   BI列: 2026/02/04 10:00（最終編集日時）
   BM列: 1（編集回数+1）
   BN列: 「再編集」
   ↓
4. 管理者に「再編集」として表示される
   ↓
5. 管理者が再承認
   BG列: 「承認済み」
   BJ列: 2（承認回数+1）
   BN列: 「再編集」（維持）
```

---

## テスト方法

### 🧪 テストスクリプト

#### 1. クイックテスト（推奨）
最も簡単な確認方法です。

```javascript
// GASエディタで実行
runQuickTests()
```

**ファイル**: `gas/quickTest.gs`

**確認内容**:
- スプレッドシートの基本情報
- BF〜BK列が存在するか
- API関数が正しく動作するか
- 新しいフィールドが返されるか

#### 2. 詳細テスト
より詳しい情報を取得します。

```javascript
// GASエディタで実行
runAllColumnInvestigationTests()
```

**ファイル**: `gas/testExistingColumns.gs`

**確認内容**:
- 各列のデータサンプル
- 承認ステータスの分布
- 日時列の使用状況
- 却下理由の使用状況
- API統合テスト

#### 3. フェーズ1機能テスト

```javascript
// GASエディタで実行
runAllPhase1Tests()
```

**ファイル**: `gas/testPhase1.gs`

**確認内容**:
- 却下理由履歴追加機能
- 新しいフィールドの返却確認
- データフローのシミュレーション

### 📝 テスト手順

1. **GASエディタを開く**
   - Googleスプレッドシートを開く
   - 「拡張機能」→「Apps Script」

2. **テストスクリプトを確認**
   - `quickTest.gs`
   - `testExistingColumns.gs`
   - `testPhase1.gs`

3. **テストを実行**
   - 関数選択で `runQuickTests` を選択
   - 実行ボタンをクリック
   - ログを確認（Ctrl+Enter または「表示」→「ログ」）

4. **結果を確認**
   - 各列にデータが存在するか
   - API関数が正しくデータを返すか
   - 新しいフィールドが含まれているか

---

## 次のステップ

### ✅ 実装前の準備

#### 1. スプレッドシートに列を追加（必須）

現在の列数が63列未満の場合、以下の列を追加してください：

| 列 | ヘッダー名 | 説明 |
|----|-----------|------|
| **BL (63)** | 初回投稿日時 | 最初に投稿された日時 |
| **BM (64)** | 編集回数 | 何回編集されたか |
| **BN (65)** | 投稿状態 | 新規投稿/再編集 |
| **BO (66)** | 却下理由履歴 | 全ての却下理由 |

**列追加手順**:
1. Googleスプレッドシートを開く
2. BL〜BO列を選択
3. ヘッダー行（1行目）に上記の名前を入力

#### 2. トリガーの確認（推奨）

GASエディタで「トリガー」を確認し、以下が設定されているか確認：

- `onFormSubmit`: フォーム送信時
- `onEdit`: シート編集時（または手動で`onEditTrigger`を設定）

**トリガー設定手順**:
1. GASエディタを開く
2. 左メニューの「トリガー」をクリック
3. 必要なトリガーを追加

#### 3. テストの実行（必須）

```javascript
runQuickTests()
```

実行して、スプレッドシートの状態を確認してください。

### 🚀 フェーズ2以降の実装

#### フェーズ2: 「却下」→「保留」への名称変更
- ステータス名の変更
- UI表示の更新
- メール本文の修正

#### フェーズ3: 新規投稿・編集後体験談の可視化
- 管理者画面でバッジ表示
  - 「NEW」（新規投稿）
  - 「再編集」（編集済み）
  - 「要再確認」（承認後編集）
- 編集回数の表示
- 最終編集日時の表示

#### フェーズ4: 再編集体験談投稿の場合却下理由が見れるように
- 体験談詳細画面に却下理由セクション追加
- 却下理由履歴の表示
- 再編集時のみ表示

#### フェーズ5: 再編集されたところの可視化（優先順位低）
- 変更箇所のハイライト表示
- 変更履歴の追跡

---

## 📁 変更ファイル一覧

### GASファイル
- ✅ `gas/adminFunctions.gs` - 管理者機能の強化
- ✅ `gas/searchExperiences.gs` - getExperienceByIdの拡張
- ✅ `gas/testPhase1.gs` - フェーズ1テストスクリプト（新規）
- ✅ `gas/testExistingColumns.gs` - 既存列調査スクリプト（新規）
- ✅ `gas/quickTest.gs` - クイックテストスクリプト（新規）

### ドキュメント
- ✅ `docs/ADMIN_FEATURE_PHASE1.md` - 統合ドキュメント（本ファイル）

---

## ✅ チェックリスト

実装前に以下を確認してください：

- [ ] スプレッドシートにBL〜BO列を追加
- [ ] 列のヘッダー名を設定
- [ ] `runQuickTests()` を実行して動作確認
- [ ] トリガーが正しく設定されているか確認
- [ ] テストデータで新規投稿→承認のフローを確認
- [ ] テストデータで却下→再編集→承認のフローを確認
- [ ] 却下理由履歴が正しく保存されるか確認
- [ ] 編集回数が正しくカウントされるか確認
- [ ] 投稿状態が正しく設定されるか確認

全てチェックできたら、フェーズ2（フロントエンド実装）に進めます！

---

## 📞 サポート

問題が発生した場合:

1. **ログを確認**: GASエディタで「表示」→「ログ」
2. **テストを実行**: `runQuickTests()` でエラー箇所を特定
3. **列の確認**: スプレッドシートでBL〜BO列が存在するか確認
4. **トリガーの確認**: GASエディタで「トリガー」を確認

---

**最終更新**: 2026年2月3日
